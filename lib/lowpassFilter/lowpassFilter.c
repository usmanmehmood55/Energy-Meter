#include "lowpassFilter.h"

static int filter_taps_lowpass[LOWPASSFILTER_TAP_NUM] = {
    -169,
    -13,
    -14,
    -14,
    -15,
    -15,
    -16,
    -16,
    -17,
    -17,
    -18,
    -18,
    -18,
    -19,
    -19,
    -19,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -19,
    -19,
    -19,
    -18,
    -18,
    -17,
    -17,
    -16,
    -15,
    -14,
    -14,
    -13,
    -12,
    -11,
    -9,
    -8,
    -7,
    -6,
    -4,
    -3,
    -1,
    1,
    3,
    4,
    6,
    8,
    10,
    13,
    15,
    17,
    20,
    22,
    25,
    27,
    30,
    33,
    36,
    39,
    42,
    45,
    49,
    52,
    55,
    59,
    62,
    66,
    70,
    73,
    77,
    81,
    85,
    89,
    93,
    98,
    102,
    106,
    111,
    115,
    119,
    124,
    128,
    133,
    138,
    142,
    147,
    152,
    157,
    161,
    166,
    171,
    176,
    181,
    186,
    190,
    195,
    200,
    205,
    210,
    215,
    220,
    224,
    229,
    234,
    239,
    243,
    248,
    253,
    257,
    262,
    266,
    271,
    275,
    279,
    283,
    288,
    292,
    296,
    300,
    304,
    307,
    311,
    315,
    318,
    321,
    325,
    328,
    331,
    334,
    337,
    339,
    342,
    344,
    347,
    349,
    351,
    353,
    355,
    357,
    358,
    360,
    361,
    362,
    363,
    364,
    365,
    366,
    366,
    367,
    367,
    367,
    367,
    367,
    366,
    366,
    365,
    364,
    363,
    362,
    361,
    360,
    358,
    357,
    355,
    353,
    351,
    349,
    347,
    344,
    342,
    339,
    337,
    334,
    331,
    328,
    325,
    321,
    318,
    315,
    311,
    307,
    304,
    300,
    296,
    292,
    288,
    283,
    279,
    275,
    271,
    266,
    262,
    257,
    253,
    248,
    243,
    239,
    234,
    229,
    224,
    220,
    215,
    210,
    205,
    200,
    195,
    190,
    186,
    181,
    176,
    171,
    166,
    161,
    157,
    152,
    147,
    142,
    138,
    133,
    128,
    124,
    119,
    115,
    111,
    106,
    102,
    98,
    93,
    89,
    85,
    81,
    77,
    73,
    70,
    66,
    62,
    59,
    55,
    52,
    49,
    45,
    42,
    39,
    36,
    33,
    30,
    27,
    25,
    22,
    20,
    17,
    15,
    13,
    10,
    8,
    6,
    4,
    3,
    1,
    -1,
    -3,
    -4,
    -6,
    -7,
    -8,
    -9,
    -11,
    -12,
    -13,
    -14,
    -14,
    -15,
    -16,
    -17,
    -17,
    -18,
    -18,
    -19,
    -19,
    -19,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -20,
    -19,
    -19,
    -19,
    -18,
    -18,
    -18,
    -17,
    -17,
    -16,
    -16,
    -15,
    -15,
    -14,
    -14,
    -13,
    -169};

void lowpassFilter_init(lowpassFilter *f)
{
    int i;
    for (i = 0; i < LOWPASSFILTER_TAP_NUM; ++i)
        f->history[i] = 0;
    f->last_index = 0;
}

void lowpassFilter_put(lowpassFilter *f, int input)
{
    f->history[f->last_index++] = input;
    if (f->last_index == LOWPASSFILTER_TAP_NUM)
        f->last_index = 0;
}

int lowpassFilter_get(lowpassFilter *f)
{
    long long acc = 0;
    int index = f->last_index, i;
    for (i = 0; i < LOWPASSFILTER_TAP_NUM; ++i)
    {
        index = index != 0 ? index - 1 : LOWPASSFILTER_TAP_NUM - 1;
        acc += (long long)f->history[index] * filter_taps_lowpass[i];
    };
    return acc >> 16;
}