#ifndef LAGFILTER_H_
#define LAGFILTER_H_

/*

FIR filter designed with
 http://t-filter.appspot.com

sampling frequency: 500 Hz

fixed point precision: 16 bits

* 0 Hz - 45 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = n/a

* 50 Hz - 60 Hz
  gain = 1
  desired ripple = 5 dB
  actual ripple = n/a

* 65 Hz - 250 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = n/a

*/

#define LAGFILTER_TAP_NUM 317

typedef struct
{
    int history[LAGFILTER_TAP_NUM];
    unsigned int last_index;
} lagFilter;

void lagFilter_init(lagFilter *f);
void lagFilter_put(lagFilter *f, int input);
int lagFilter_get(lagFilter *f);

static int filter_taps[LAGFILTER_TAP_NUM] = {
    -4,
    2,
    2,
    1,
    1,
    1,
    1,
    1,
    2,
    2,
    1,
    -2,
    -5,
    -6,
    -4,
    1,
    8,
    12,
    11,
    4,
    -7,
    -17,
    -20,
    -13,
    2,
    18,
    28,
    25,
    10,
    -12,
    -30,
    -35,
    -24,
    0,
    25,
    39,
    35,
    15,
    -12,
    -32,
    -37,
    -24,
    -2,
    18,
    27,
    23,
    9,
    -4,
    -10,
    -8,
    -2,
    0,
    -5,
    -14,
    -20,
    -14,
    7,
    33,
    50,
    44,
    12,
    -34,
    -73,
    -81,
    -49,
    12,
    75,
    107,
    90,
    29,
    -50,
    -108,
    -117,
    -71,
    7,
    80,
    113,
    92,
    32,
    -35,
    -77,
    -77,
    -43,
    0,
    28,
    29,
    12,
    -1,
    6,
    31,
    55,
    51,
    6,
    -67,
    -129,
    -139,
    -74,
    48,
    171,
    228,
    179,
    33,
    -148,
    -275,
    -279,
    -149,
    59,
    247,
    323,
    249,
    60,
    -151,
    -283,
    -277,
    -148,
    32,
    171,
    208,
    144,
    36,
    -46,
    -62,
    -25,
    12,
    -4,
    -85,
    -178,
    -201,
    -92,
    133,
    374,
    485,
    358,
    0,
    -448,
    -760,
    -741,
    -338,
    305,
    893,
    1118,
    818,
    79,
    -779,
    -1344,
    -1309,
    -640,
    387,
    1298,
    1646,
    1232,
    217,
    -943,
    -1700,
    -1683,
    -881,
    345,
    1424,
    1851,
    1424,
    345,
    -881,
    -1683,
    -1700,
    -943,
    217,
    1232,
    1646,
    1298,
    387,
    -640,
    -1309,
    -1344,
    -779,
    79,
    818,
    1118,
    893,
    305,
    -338,
    -741,
    -760,
    -448,
    0,
    358,
    485,
    374,
    133,
    -92,
    -201,
    -178,
    -85,
    -4,
    12,
    -25,
    -62,
    -46,
    36,
    144,
    208,
    171,
    32,
    -148,
    -277,
    -283,
    -151,
    60,
    249,
    323,
    247,
    59,
    -149,
    -279,
    -275,
    -148,
    33,
    179,
    228,
    171,
    48,
    -74,
    -139,
    -129,
    -67,
    6,
    51,
    55,
    31,
    6,
    -1,
    12,
    29,
    28,
    0,
    -43,
    -77,
    -77,
    -35,
    32,
    92,
    113,
    80,
    7,
    -71,
    -117,
    -108,
    -50,
    29,
    90,
    107,
    75,
    12,
    -49,
    -81,
    -73,
    -34,
    12,
    44,
    50,
    33,
    7,
    -14,
    -20,
    -14,
    -5,
    0,
    -2,
    -8,
    -10,
    -4,
    9,
    23,
    27,
    18,
    -2,
    -24,
    -37,
    -32,
    -12,
    15,
    35,
    39,
    25,
    0,
    -24,
    -35,
    -30,
    -12,
    10,
    25,
    28,
    18,
    2,
    -13,
    -20,
    -17,
    -7,
    4,
    11,
    12,
    8,
    1,
    -4,
    -6,
    -5,
    -2,
    1,
    2,
    2,
    1,
    1,
    1,
    1,
    1,
    2,
    2,
    -4};

void lagFilter_init(lagFilter *f)
{
    int i;
    for (i = 0; i < LAGFILTER_TAP_NUM; ++i)
        f->history[i] = 0;
    f->last_index = 0;
}

void lagFilter_put(lagFilter *f, int input)
{
    f->history[f->last_index++] = input;
    if (f->last_index == LAGFILTER_TAP_NUM)
        f->last_index = 0;
}

int lagFilter_get(lagFilter *f)
{
    long long acc = 0;
    int index = f->last_index, i;
    for (i = 0; i < LAGFILTER_TAP_NUM; ++i)
    {
        index = index != 0 ? index - 1 : LAGFILTER_TAP_NUM - 1;
        acc += (long long)f->history[index] * filter_taps[i];
    };
    return acc >> 16;
}

#endif